name: debootstrap
on:
  workflow_dispatch:
jobs:
  delete-release:
    runs-on: ubuntu-latest
    steps:
      - name: Delete tag and release
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: ubuntu
          github_token: ${{ secrets.MY_TOKEN }}
          delete_release: true
          repo: k930520/build
  build-ubuntu:
    if: ${{ always() }}
    needs: delete-release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        QEMU_VER: [v6.1.0-1]
        DOCKER_REPO: [docker.io/multiarch/ubuntu-debootstrap]
        VERSION: ["22.04"]
        UNAME_ARCH: [armv7l]
        include:
          - {ARCH: armhf,   QEMU_ARCH: arm,     UNAME_ARCH: armv7l}
          - {VERSION: "22.04", INCLUDE: "iproute2,wget",  SUITE: jammy}
        exclude:
          - {VERSION: "22.04", UNAME_ARCH: powerpc}
    steps:
      - uses: actions/checkout@v2
      - name: Build
        run: |
          sudo add-apt-repository 'deb http://archive.ubuntu.com/ubuntu focal main universe'
          sudo apt-get update && sudo apt-get install -y qemu-user-static debootstrap
          ./update.sh -a ${{ matrix.ARCH }} -v ${{ matrix.VERSION }} -q ${{ matrix.QEMU_ARCH }} -u ${{ matrix.QEMU_VER }} -d ${{ matrix.DOCKER_REPO }} -s ${{ matrix.SUITE }} -i ${{ matrix.INCLUDE }} -o ${{ matrix.UNAME_ARCH }}
      - name: Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}
        with:
          tag_name: ubuntu
          files: 22.04/*
          prerelease: false
          
      - name: Delete workflow runs
        uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}
        with:
          repository: k930520/build
          status: completed
